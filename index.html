<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm tạo bảng lương - VTPA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            display: none;
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .payroll-preview {
            font-family: 'DejaVu Sans', 'Times New Roman', serif;
            font-size: 12px;
            line-height: 1.4;
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            background: white;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            word-wrap: break-word;
            text-align: left;
        }
        
        th:nth-child(3), td:nth-child(3) {
            text-align: right;
        }
        
        @media print {
            body { font-size: 10px; }
            .payroll-preview { 
                font-size: 10px; 
                padding: 10mm;
                page-break-inside: avoid;
            }
        }
        
        .btn-debug {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-debug:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-debug:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-debug.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Toast Messages -->
    <div id="toast" class="toast"></div>
    
    <!-- Header -->
    <div class="bg-white shadow-md p-6 mb-6">
        <div class="flex items-center justify-center max-w-4xl mx-auto">
            <img id="logo" src="https://btbinh2710.github.io/vtpa-payroll/logo.jpg" crossOrigin="anonymous" 
                 alt="VinFast Logo" class="h-16 w-auto mr-6" 
                 onload="console.log('✅ Logo loaded successfully')"
                 onerror="console.error('❌ Logo failed to load'); this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
            <div id="logo-fallback" style="display: none;" class="h-16 w-24 mr-6 bg-blue-600 text-white flex items-center justify-center font-bold rounded">
                VINFAST
            </div>
            <div class="text-center">
                <h1 class="text-xl font-bold text-gray-800">CÔNG TY CỔ PHẦN 27-7 HỒNG QUANG</h1>
                <p class="text-sm text-gray-600">Km2+500, đường Phan Trọng Tuệ, Thanh Liệt, Thanh Trì, Hà Nội</p>
                <p class="text-sm text-gray-600">MST: 0102147234 - Hotline: 0902279898</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4">
        <!-- Tabs -->
        <div class="mb-6">
            <div class="flex space-x-1 bg-white p-1 rounded-lg shadow">
                <button class="tab-btn flex-1 py-2 px-4 rounded-md font-medium text-sm transition-colors duration-200 bg-blue-500 text-white" data-tab="manual">
                    <i class="fas fa-edit mr-2"></i>Nhập thủ công
                </button>
                <button class="tab-btn flex-1 py-2 px-4 rounded-md font-medium text-sm transition-colors duration-200 text-gray-600 hover:text-gray-800" data-tab="excel">
                    <i class="fas fa-file-excel mr-2"></i>Upload Excel
                </button>
                <button class="tab-btn flex-1 py-2 px-4 rounded-md font-medium text-sm transition-colors duration-200 text-gray-600 hover:text-gray-800" data-tab="email">
                    <i class="fas fa-envelope mr-2"></i>Gửi Email
                </button>
                <button class="tab-btn flex-1 py-2 px-4 rounded-md font-medium text-sm transition-colors duration-200 text-gray-600 hover:text-gray-800" data-tab="settings">
                    <i class="fas fa-cog mr-2"></i>Cài đặt
                </button>
            </div>
        </div>
        
        <!-- Tab Contents -->
        
        <!-- Manual Input Tab -->
        <div id="tab-manual" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Nhập thông tin nhân viên</h2>
                <form id="manualForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                            <input type="text" id="fullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mã nhân viên</label>
                            <input type="text" id="employeeId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bộ phận/Chi nhánh</label>
                            <input type="text" id="department" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="VF PTT HÀ NỘI" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Chức vụ</label>
                            <input type="text" id="position" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="TVBH" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ngày công thực tế</label>
                            <input type="number" id="workDays" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" max="31" value="25" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mức lương</label>
                            <input type="number" id="baseSalary" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="8500000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tỷ lệ hưởng</label>
                            <select id="salaryPercentage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="100">100% (Nhân viên chính thức)</option>
                                <option value="80">80% (Nhân viên thử việc)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Số xe ký trong tháng</label>
                            <input type="number" id="carsigned" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" value="5" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lương tăng ca</label>
                            <input type="number" id="overtime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="500000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Thưởng</label>
                            <input type="number" id="bonus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="2000000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phụ cấp tiền ăn</label>
                            <input type="number" id="mealAllowance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="500000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phụ cấp trách nhiệm</label>
                            <input type="number" id="responsibilityAllowance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">BHXH</label>
                            <input type="number" id="socialInsurance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Khấu trừ tiền ăn</label>
                            <input type="number" id="mealDeduction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Khấu trừ qui chế</label>
                            <input type="number" id="regulationDeduction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Thuế TNCN</label>
                            <input type="number" id="incomeTax" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Khấu trừ khác</label>
                            <input type="number" id="otherDeduction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" value="150000">
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" id="previewBtn" class="btn-debug bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md flex items-center">
                            <i class="fas fa-eye mr-2"></i>👁️ Xem trước
                            <div class="loading-spinner ml-2"></div>
                        </button>
                        <button type="button" id="exportBtn" class="btn-debug bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md flex items-center">
                            <i class="fas fa-download mr-2"></i>📄 Xuất PDF
                            <div class="loading-spinner ml-2"></div>
                        </button>
                        <button type="button" id="calculateBtn" class="btn-debug bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-md flex items-center">
                            <i class="fas fa-calculator mr-2"></i>Tính toán
                        </button>
                    </div>
                    
                    <!-- Calculation Results -->
                    <div id="calculationResults" class="mt-6 p-4 bg-gray-50 rounded-md" style="display: none;">
                        <h3 class="font-semibold mb-2">Kết quả tính toán:</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>Lương thực tế: <span id="actualSalary" class="font-medium"></span></div>
                            <div>Tổng thu nhập: <span id="totalIncome" class="font-medium"></span></div>
                            <div>Tổng khấu trừ: <span id="totalDeduction" class="font-medium"></span></div>
                            <div>Thực lĩnh: <span id="netSalary" class="font-medium text-green-600"></span></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Excel Upload Tab -->
        <div id="tab-excel" class="tab-content" style="display: none;">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Upload file Excel</h2>
                
                <div class="mb-6">
                    <button id="downloadTemplateBtn" class="btn-debug bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-download mr-2"></i>Tải template Excel
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chọn file Excel</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="employeeTable" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">Danh sách nhân viên</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 border-b text-left">Họ tên</th>
                                    <th class="px-4 py-2 border-b text-left">Mã NV</th>
                                    <th class="px-4 py-2 border-b text-left">Mức lương</th>
                                    <th class="px-4 py-2 border-b text-left">Tỷ lệ hưởng</th>
                                    <th class="px-4 py-2 border-b text-left">Ngày công</th>
                                    <th class="px-4 py-2 border-b text-left">Email</th>
                                    <th class="px-4 py-2 border-b text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex space-x-4">
                        <button id="previewAllBtn" class="btn-debug bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                            <i class="fas fa-eye mr-2"></i>Xem trước tất cả
                        </button>
                        <button id="exportAllBtn" class="btn-debug bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                            <i class="fas fa-download mr-2"></i>Xuất tất cả PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Tab -->
        <div id="tab-email" class="tab-content" style="display: none;">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Gửi email bảng lương</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Server</label>
                        <input type="text" id="smtpServer" value="smtp.vtpa.vn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                        <input type="number" id="smtpPort" value="587" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email gửi</label>
                        <input type="email" id="fromEmail" value="hanhchinh@vtpa.vn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                        <input type="password" id="emailPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-6">
                    <button id="testConnectionBtn" class="btn-debug bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-plug mr-2"></i>⚙️ Test Connection
                        <div class="loading-spinner ml-2"></div>
                    </button>
                </div>
                
                <div id="emailList" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4">Danh sách gửi email</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 border-b">
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th class="px-4 py-2 border-b text-left">Họ tên</th>
                                    <th class="px-4 py-2 border-b text-left">Email</th>
                                    <th class="px-4 py-2 border-b text-left">Trạng thái</th>
                                    <th class="px-4 py-2 border-b text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="emailListBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex space-x-4">
                        <button id="sendSelectedBtn" class="btn-debug bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                            <i class="fas fa-envelope mr-2"></i>📧 Gửi đã chọn
                        </button>
                        <button id="sendAllEmailBtn" class="btn-debug bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                            <i class="fas fa-paper-plane mr-2"></i>Gửi tất cả
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content" style="display: none;">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4">Cài đặt hệ thống</h2>
                
                <div class="mb-6">
                    <h3 class="text-md font-medium mb-2">Thông tin công ty</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tên công ty</label>
                            <input type="text" value="CÔNG TY CỔ PHẦN 27-7 HỒNG QUANG" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">MST</label>
                            <input type="text" value="0102147234" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                            <input type="text" value="Km2+500, đường Phan Trọng Tuệ, Thanh Liệt, Thanh Trì, Hà Nội" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-md font-medium mb-2">Cài đặt tính lương</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Công chuẩn (ngày/tháng)</label>
                            <input type="number" value="24" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ngày làm việc/tuần</label>
                            <input type="number" value="6" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Xem trước bảng lương</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="previewContent"></div>
            <div class="mt-4 flex justify-end space-x-4">
                <button id="modalExportBtn" class="btn-debug bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-download mr-2"></i>Xuất PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 VTPA Payroll System - Debug Mode Activated');
        
        // Global variables
        let currentEmployeeData = null;
        let employeesData = [];
        
        // Utility functions
        function showToast(message, type = 'success') {
            console.log(`📢 Toast: ${type} - ${message}`);
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function showError(message) {
            console.error(`❌ Error: ${message}`);
            showToast(message, 'error');
        }
        
        function showSuccess(message) {
            console.log(`✅ Success: ${message}`);
            showToast(message, 'success');
        }
        
        function setButtonLoading(button, loading) {
            const spinner = button.querySelector('.loading-spinner');
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
                if (spinner) spinner.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (spinner) spinner.style.display = 'none';
            }
        }
        
        // Tab switching
        function initializeTabs() {
            console.log('🔧 Initializing tabs...');
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    console.log(`📑 Switching to tab: ${this.dataset.tab}`);
                    
                    // Update tab buttons
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('text-gray-600');
                    });
                    this.classList.add('bg-blue-500', 'text-white');
                    this.classList.remove('text-gray-600');
                    
                    // Update tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(`tab-${this.dataset.tab}`).style.display = 'block';
                });
            });
        }
        
        // Employee data collection
        function getEmployeeData() {
            try {
                const baseSalary = parseInt(document.getElementById('baseSalary').value) || 0;
                const percentage = parseInt(document.getElementById('salaryPercentage').value) || 100;
                const workDays = parseInt(document.getElementById('workDays').value) || 0;
                
                // Calculate effective salary (applying percentage only to base salary)
                const effectiveSalary = baseSalary * (percentage / 100);
                const actualSalary = Math.min(effectiveSalary * (workDays / 24), effectiveSalary);
                
                const data = {
                    fullName: document.getElementById('fullName').value || '',
                    employeeId: document.getElementById('employeeId').value || '',
                    department: document.getElementById('department').value || '',
                    position: document.getElementById('position').value || '',
                    email: document.getElementById('email').value || '',
                    workDays: workDays,
                    baseSalary: baseSalary,
                    salaryPercentage: percentage,
                    carsigned: parseInt(document.getElementById('carsigned').value) || 0,
                    
                    // Income (other than base salary - no percentage applied)
                    actualSalary: actualSalary,
                    overtime: parseInt(document.getElementById('overtime').value) || 0,
                    bonus: parseInt(document.getElementById('bonus').value) || 0,
                    mealAllowance: parseInt(document.getElementById('mealAllowance').value) || 0,
                    responsibilityAllowance: parseInt(document.getElementById('responsibilityAllowance').value) || 0,
                    
                    // Deductions
                    socialInsurance: parseInt(document.getElementById('socialInsurance').value) || 0,
                    mealDeduction: parseInt(document.getElementById('mealDeduction').value) || 0,
                    regulationDeduction: parseInt(document.getElementById('regulationDeduction').value) || 0,
                    incomeTax: parseInt(document.getElementById('incomeTax').value) || 0,
                    otherDeduction: parseInt(document.getElementById('otherDeduction').value) || 0
                };
                
                // Calculate totals
                data.totalIncome = data.actualSalary + data.overtime + data.bonus + data.mealAllowance + data.responsibilityAllowance;
                data.totalDeduction = data.socialInsurance + data.mealDeduction + data.regulationDeduction + data.incomeTax + data.otherDeduction;
                data.netSalary = data.totalIncome - data.totalDeduction;
                
                console.log('📊 Employee data collected:', data);
                return data;
            } catch (error) {
                console.error('❌ Error collecting employee data:', error);
                throw error;
            }
        }
        
        // Number formatting
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }
        
        function numberToWords(num) {
            // Simplified Vietnamese number to words conversion
            const units = ['', 'nghìn', 'triệu', 'tỷ'];
            const digits = ['không', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            
            if (num === 0) return 'không đồng';
            
            let result = '';
            let unitIndex = 0;
            
            while (num > 0) {
                const chunk = num % 1000;
                if (chunk > 0) {
                    let chunkText = '';
                    
                    const hundreds = Math.floor(chunk / 100);
                    const tens = Math.floor((chunk % 100) / 10);
                    const ones = chunk % 10;
                    
                    if (hundreds > 0) {
                        chunkText += digits[hundreds] + ' trăm ';
                    }
                    
                    if (tens > 1) {
                        chunkText += digits[tens] + ' mười ';
                    } else if (tens === 1) {
                        chunkText += 'mười ';
                    }
                    
                    if (ones > 0) {
                        chunkText += digits[ones] + ' ';
                    }
                    
                    result = chunkText + units[unitIndex] + ' ' + result;
                }
                
                num = Math.floor(num / 1000);
                unitIndex++;
            }
            
            return result.trim() + ' đồng';
        }
        
        // Calculate salary
        function calculateSalary() {
            console.log('🧮 Calculating salary...');
            try {
                const data = getEmployeeData();
                
                // Update display
                document.getElementById('actualSalary').textContent = formatNumber(data.actualSalary) + ' VNĐ';
                document.getElementById('totalIncome').textContent = formatNumber(data.totalIncome) + ' VNĐ';
                document.getElementById('totalDeduction').textContent = formatNumber(data.totalDeduction) + ' VNĐ';
                document.getElementById('netSalary').textContent = formatNumber(data.netSalary) + ' VNĐ';
                
                document.getElementById('calculationResults').style.display = 'block';
                
                showSuccess('Tính toán hoàn thành!');
                console.log('✅ Salary calculated successfully');
                
                return data;
            } catch (error) {
                console.error('❌ Calculation error:', error);
                showError('Lỗi tính toán: ' + error.message);
                return null;
            }
        }
        
        // Generate payroll HTML
        function generatePayrollHTML(data) {
            console.log('📄 Generating payroll HTML for:', data.fullName);
            
            const currentDate = new Date();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const year = currentDate.getFullYear();
            
            return `
                <div class="payroll-preview">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                            <img src="https://btbinh2710.github.io/vtpa-payroll/logo.jpg" crossOrigin="anonymous" 
                                 style="height: 40px; margin-right: 15px;" 
                                 onerror="this.style.display='none'">
                            <div>
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 3px;">CÔNG TY CỔ PHẦN 27-7 HỒNG QUANG</div>
                                <div style="font-size: 11px; margin-bottom: 2px;">Km2+500, đường Phan Trọng Tuệ, Thanh Liệt, Thanh Trì, Hà Nội</div>
                                <div style="font-size: 11px;">MST: 0102147234 - Hotline: 0902279898</div>
                            </div>
                        </div>
                    </div>
                    
                    <h2 style="text-align: center; font-size: 14px; font-weight: bold; margin: 15px 0;">
                        BẢNG THÔNG BÁO LƯƠNG THÁNG ${month}/${year}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 11px;">
                        <div>
                            <div style="margin-bottom: 3px;"><strong>Họ và tên:</strong> ${data.fullName}</div>
                            <div style="margin-bottom: 3px;"><strong>Bộ phận/Chi nhánh:</strong> ${data.department}</div>
                            <div style="margin-bottom: 3px;"><strong>Ngày công thực tế:</strong> ${data.workDays}</div>
                            <div style="margin-bottom: 3px;"><strong>Số xe ký trong tháng:</strong> ${data.carsigned}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 3px;"><strong>Mã nhân viên:</strong> ${data.employeeId}</div>
                            <div style="margin-bottom: 3px;"><strong>Chức vụ:</strong> ${data.position}</div>
                            <div style="margin-bottom: 3px;"><strong>Mức lương:</strong> ${formatNumber(data.baseSalary)}</div>
                            <div style="margin-bottom: 3px;"><strong>Tỷ lệ hưởng:</strong> ${data.salaryPercentage}%</div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 15px;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 4px; width: 8%; text-align: center;">STT</th>
                                <th style="border: 1px solid #ddd; padding: 4px; width: 60%; text-align: left;">Khoản mục</th>
                                <th style="border: 1px solid #ddd; padding: 4px; width: 20%; text-align: right;">Số tiền (VNĐ)</th>
                                <th style="border: 1px solid #ddd; padding: 4px; width: 12%; text-align: left;">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold;">I</td>
                                <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold;">THU NHẬP</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">1</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Lương</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px; padding-left: 15px;">Lương thực tế (${data.workDays} công)</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.actualSalary)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px; padding-left: 15px;">Lương tăng ca</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.overtime)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px; padding-left: 15px;">Thưởng</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.bonus)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">2</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Phụ cấp</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px; padding-left: 15px;">Phụ cấp tiền ăn</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.mealAllowance)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px; padding-left: 15px;">Phụ cấp trách nhiệm</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.responsibilityAllowance)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr style="background-color: #f9f9f9; font-weight: bold;">
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;">TỔNG THU NHẬP (I)</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.totalIncome)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold;">II</td>
                                <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold;">KHẤU TRỪ</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">1</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">BHXH</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.socialInsurance)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">2</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Khấu trừ tiền ăn</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.mealDeduction)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">3</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Khấu trừ qui chế</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.regulationDeduction)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">4</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Thuế TNCN</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.incomeTax)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">5</td>
                                <td style="border: 1px solid #ddd; padding: 4px;">Khấu trừ khác</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.otherDeduction)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr style="background-color: #f9f9f9; font-weight: bold;">
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                                <td style="border: 1px solid #ddd; padding: 4px;">TỔNG KHẤU TRỪ (II)</td>
                                <td style="border: 1px solid #ddd; padding: 4px; text-align: right;">${formatNumber(data.totalDeduction)}</td>
                                <td style="border: 1px solid #ddd; padding: 4px;"></td>
                            </tr>
                            <tr style="background-color: #e6f3ff; font-weight: bold; font-size: 11px;">
                                <td style="border: 1px solid #ddd; padding: 6px;"></td>
                                <td style="border: 1px solid #ddd; padding: 6px;">THỰC LĨNH (I - II)</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${formatNumber(data.netSalary)}</td>
                                <td style="border: 1px solid #ddd; padding: 6px;"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-bottom: 15px; font-size: 11px;">
                        <strong>Bằng chữ:</strong> ${numberToWords(data.netSalary).charAt(0).toUpperCase() + numberToWords(data.netSalary).slice(1)}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 15px; font-size: 11px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 40px;">NGƯỜI LẬP BẢNG</div>
                            <div>(Ký, ghi rõ họ tên)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 40px;">NGƯỜI NHẬN</div>
                            <div>(Ký, ghi rõ họ tên)</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 9px; line-height: 1.3;">
                        <strong>Ghi chú:</strong>
                        <div style="margin-top: 5px;">
                            - Bảng lương này có giá trị thay thế cho phiếu lương và chỉ được phát hành một lần.<br>
                            - Nếu có thắc mắc, vui lòng liên hệ phòng Nhân sự trong vòng 3 ngày làm việc kể từ ngày nhận bảng lương.<br>
                            - Bảng lương này được lập thành 02 bản, 01 bản Công ty lưu và 01 bản người lao động giữ.
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Debug Preview Function
        function debugPreview(employeeData = null) {
            console.log('🔍 Preview clicked for:', employeeData?.fullName || 'manual input');
            try {
                const data = employeeData || getEmployeeData();
                if (!data) throw new Error('Không có dữ liệu nhân viên');
                
                currentEmployeeData = data;
                const html = generatePayrollHTML(data);
                document.getElementById('previewContent').innerHTML = html;
                document.getElementById('previewModal').style.display = 'block';
                
                console.log('✅ Preview modal opened');
                showSuccess('Xem trước bảng lương thành công!');
            } catch (error) {
                console.error('❌ Preview error:', error);
                showError('Lỗi xem trước: ' + error.message);
            }
        }
        
        // Font DejaVu Sans base64 (placeholder, replace with actual base64)
        const dejavuSans = 'data:application/x-font-ttf;base64,...'; // Thay bằng base64 của DejaVuSans.ttf
        
        // Debug Export Function
        function debugExport(employeeData = null) {
            console.log('📄 Export clicked for:', employeeData?.fullName || 'manual input');
            try {
                const data = employeeData || getEmployeeData();
                if (!data) throw new Error('Không có dữ liệu nhân viên');
                
                const fileName = `BangLuong_${data.fullName.replace(/\s+/g, '')}_${new Date().getMonth() + 1}-${new Date().getFullYear()}.pdf`;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = generatePayrollHTML(data);
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                document.body.appendChild(tempDiv);
                
                html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Add DejaVu Sans font
                    pdf.addFileToVFS('DejaVuSans.ttf', dejavuSans);
                    pdf.addFont('DejaVuSans.ttf', 'DejaVuSans', 'normal');
                    pdf.setFont('DejaVuSans');
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
                    pdf.save(fileName);
                    
                    document.body.removeChild(tempDiv);
                    console.log('✅ PDF exported successfully');
                    showSuccess('Xuất PDF thành công!');
                }).catch(error => {
                    document.body.removeChild(tempDiv);
                    throw error;
                });
                
            } catch (error) {
                console.error('❌ Export error:', error);
                showError('Lỗi xuất PDF: ' + error.message);
            }
        }
        
        // Debug Email Function
        function debugEmail(employeeData) {
            console.log('📧 Email clicked for:', employeeData.fullName);
            try {
                // Simulate email validation
                const fromEmail = document.getElementById('fromEmail').value;
                const password = document.getElementById('emailPassword').value;
                
                if (!fromEmail || !password) {
                    throw new Error('Vui lòng cấu hình email trước khi gửi');
                }
                
                if (!employeeData.email) {
                    throw new Error('Nhân viên chưa có email');
                }
                
                // Simulate email sending
                setTimeout(() => {
                    console.log('✅ Email sent successfully');
                    showSuccess(`Đã gửi email cho ${employeeData.fullName}`);
                }, 1000);
                
            } catch (error) {
                console.error('❌ Email error:', error);
                showError('Lỗi gửi email: ' + error.message);
            }
        }
        
        // Debug Upload Function
        function debugUpload(file) {
            console.log('📊 Upload clicked:', file.name);
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Process and display employee data
                        employeesData = jsonData.map(row => ({
                            fullName: row['Họ và tên'] || '',
                            employeeId: row['Mã nhân viên'] || '',
                            department: row['Bộ phận'] || 'VF PTT HÀ NỘI',
                            position: row['Chức vụ'] || 'TVBH',
                            email: row['Email'] || '',
                            workDays: parseInt(row['Ngày công thực tế']) || 25,
                            baseSalary: parseInt(row['Mức lương']) || 0,
                            salaryPercentage: parseInt(row['Tỷ lệ hưởng']) || 100,
                            carsigned: parseInt(row['Số xe ký']) || 0,
                            overtime: parseInt(row['Lương tăng ca']) || 0,
                            bonus: parseInt(row['Thưởng']) || 0,
                            mealAllowance: parseInt(row['Phụ cấp ăn']) || 0,
                            responsibilityAllowance: parseInt(row['Phụ cấp trách nhiệm']) || 0,
                            socialInsurance: parseInt(row['BHXH']) || 0,
                            mealDeduction: parseInt(row['Khấu trừ ăn']) || 0,
                            regulationDeduction: parseInt(row['Khấu trừ qui chế']) || 0,
                            incomeTax: parseInt(row['Thuế TNCN']) || 0,
                            otherDeduction: parseInt(row['Khấu trừ khác']) || 0
                        }));
                        
                        // Calculate for each employee
                        employeesData.forEach(emp => {
                            const effectiveSalary = emp.baseSalary * (emp.salaryPercentage / 100);
                            emp.actualSalary = Math.min(effectiveSalary * (emp.workDays / 24), effectiveSalary);
                            emp.totalIncome = emp.actualSalary + emp.overtime + emp.bonus + emp.mealAllowance + emp.responsibilityAllowance;
                            emp.totalDeduction = emp.socialInsurance + emp.mealDeduction + emp.regulationDeduction + emp.incomeTax + emp.otherDeduction;
                            emp.netSalary = emp.totalIncome - emp.totalDeduction;
                        });
                        
                        displayEmployeeTable(employeesData);
                        console.log('✅ Excel processed:', employeesData.length, 'employees');
                        showSuccess(`Đã xử lý ${employeesData.length} nhân viên từ Excel`);
                        
                    } catch (error) {
                        throw new Error('Lỗi đọc file Excel: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('❌ Upload error:', error);
                showError('Lỗi upload Excel: ' + error.message);
            }
        }
        
        // Debug Connection Function
        function debugConnection() {
            console.log('⚙️ Test connection clicked');
            const button = document.getElementById('testConnectionBtn');
            setButtonLoading(button, true);
            
            try {
                const server = document.getElementById('smtpServer').value;
                const port = document.getElementById('smtpPort').value;
                const email = document.getElementById('fromEmail').value;
                const password = document.getElementById('emailPassword').value;
                
                if (!server || !port || !email || !password) {
                    throw new Error('Vui lòng điền đầy đủ thông tin SMTP');
                }
                
                // Simulate connection test
                setTimeout(() => {
                    setButtonLoading(button, false);
                    console.log('✅ SMTP connection successful');
                    showSuccess('Kết nối email thành công!');
                }, 2000);
                
            } catch (error) {
                setButtonLoading(button, false);
                console.error('❌ Connection error:', error);
                showError('Lỗi kết nối: ' + error.message);
            }
        }
        
        // Display employee table
        function displayEmployeeTable(employees) {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';
            
            employees.forEach((emp, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${emp.fullName}</td>
                    <td class="px-4 py-2 border-b">${emp.employeeId}</td>
                    <td class="px-4 py-2 border-b">${formatNumber(emp.baseSalary)}</td>
                    <td class="px-4 py-2 border-b">${emp.salaryPercentage}%</td>
                    <td class="px-4 py-2 border-b">${emp.workDays}</td>
                    <td class="px-4 py-2 border-b">${emp.email}</td>
                    <td class="px-4 py-2 border-b text-center">
                        <button class="btn-debug bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded mr-1 text-sm" onclick="debugPreview(employeesData[${index}])">
                            👁️
                        </button>
                        <button class="btn-debug bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1 text-sm" onclick="debugExport(employeesData[${index}])">
                            📄
                        </button>
                        <button class="btn-debug bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-sm" onclick="debugEmail(employeesData[${index}])">
                            📧
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('employeeTable').style.display = 'block';
        }
        
        // Download Excel template
        function downloadTemplate() {
            console.log('📋 Downloading Excel template...');
            try {
                const templateData = [
                    {
                        'Họ và tên': 'Nguyễn Văn A',
                        'Mã nhân viên': '1001',
                        'Bộ phận': 'VF PTT HÀ NỘI',
                        'Chức vụ': 'TVBH',
                        'Email': 'nguyenvana@example.com',
                        'Ngày công thực tế': 25,
                        'Mức lương': 8500000,
                        'Tỷ lệ hưởng': 100,
                        'Số xe ký': 5,
                        'Lương tăng ca': 500000,
                        'Thưởng': 2000000,
                        'Phụ cấp ăn': 500000,
                        'Phụ cấp trách nhiệm': 0,
                        'BHXH': 0,
                        'Khấu trừ ăn': 0,
                        'Khấu trừ qui chế': 0,
                        'Thuế TNCN': 0,
                        'Khấu trừ khác': 150000
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template');
                XLSX.writeFile(wb, 'Template_BangLuong_VTPA.xlsx');
                
                console.log('✅ Template downloaded successfully');
                showSuccess('Đã tải template Excel thành công!');
            } catch (error) {
                console.error('❌ Template download error:', error);
                showError('Lỗi tải template: ' + error.message);
            }
        }
        
        // Bind all events
        function bindButtonEvents() {
            console.log('🔗 Binding button events...');
            
            // Manual form buttons
            const previewBtn = document.getElementById('previewBtn');
            const exportBtn = document.getElementById('exportBtn');
            const calculateBtn = document.getElementById('calculateBtn');
            
            if (previewBtn) {
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔍 Manual preview clicked');
                    const button = this;
                    setButtonLoading(button, true);
                    setTimeout(() => {
                        debugPreview();
                        setButtonLoading(button, false);
                    }, 500);
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('📄 Manual export clicked');
                    const button = this;
                    setButtonLoading(button, true);
                    setTimeout(() => {
                        debugExport();
                        setButtonLoading(button, false);
                    }, 500);
                });
            }
            
            if (calculateBtn) {
                calculateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🧮 Calculate clicked');
                    calculateSalary();
                });
            }
            
            // Excel upload
            const excelFile = document.getElementById('excelFile');
            if (excelFile) {
                excelFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        debugUpload(file);
                    }
                });
            }
            
            // Download template
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    downloadTemplate();
                });
            }
            
            // Test connection
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    debugConnection();
                });
            }
            
            // Modal controls
            const closeModal = document.getElementById('closeModal');
            const previewModal = document.getElementById('previewModal');
            const modalExportBtn = document.getElementById('modalExportBtn');
            
            if (closeModal) {
                closeModal.addEventListener('click', function() {
                    console.log('❌ Modal closed');
                    previewModal.style.display = 'none';
                });
            }
            
            if (modalExportBtn) {
                modalExportBtn.addEventListener('click', function() {
                    console.log('📄 Modal export clicked');
                    if (currentEmployeeData) {
                        debugExport(currentEmployeeData);
                    }
                });
            }
            
            // Close modal on backdrop click
            if (previewModal) {
                previewModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('❌ Modal closed via backdrop');
                        this.style.display = 'none';
                    }
                });
            }
            
            // ESC key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && previewModal.style.display === 'block') {
                    console.log('❌ Modal closed via ESC');
                    previewModal.style.display = 'none';
                }
            });
            
            console.log('✅ All button events bound successfully');
        }
        
        // Check logo load
        function checkLogoLoad() {
            console.log('🖼️ Checking logo load...');
            const logo = document.getElementById('logo');
            if (logo.complete) {
                if (logo.naturalWidth === 0) {
                    console.warn('⚠️ Logo failed to load, showing fallback');
                    document.getElementById('logo-fallback').style.display = 'block';
                    logo.style.display = 'none';
                } else {
                    console.log('✅ Logo loaded successfully');
                }
            }
        }
        
        // Initialize modals
        function initializeModals() {
            console.log('🗂️ Initializing modals...');
            // Modal initialization code here
        }
        
        // Setup form validation
        function setupFormValidation() {
            console.log('📝 Setting up form validation...');
            
            // Add real-time validation
            const requiredFields = ['fullName', 'employeeId', 'email', 'baseSalary'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        if (this.value.trim() === '') {
                            this.classList.add('border-red-500');
                        } else {
                            this.classList.remove('border-red-500');
                        }
                    });
                }
            });
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, binding events...');
            
            try {
                initializeTabs();
                bindButtonEvents();
                checkLogoLoad();
                initializeModals();
                setupFormValidation();
                
                console.log('✅ All events bound successfully');
                showSuccess('Hệ thống đã sẵn sàng!');
                
                // Auto-calculate when form changes
                const formFields = document.querySelectorAll('#manualForm input, #manualForm select');
                formFields.forEach(field => {
                    field.addEventListener('change', function() {
                        if (document.getElementById('calculationResults').style.display !== 'none') {
                            calculateSalary();
                        }
                    });
                });
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                showError('Lỗi khởi tạo hệ thống: ' + error.message);
            }
        });
        
        console.log('📚 VTPA Payroll System initialized - All debug functions ready');
    </script>
</body>
</html>